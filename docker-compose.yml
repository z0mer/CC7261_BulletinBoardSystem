version: '3.8'

services:
  # Servidor de Referência (C#)
  referencia:
    build:
      context: ./csharp/referencia
      dockerfile: Dockerfile
    container_name: bbs_referencia
    networks:
      - bbs_network
    ports:
      - "5559:5559"
    environment:
      - PORTA=5559
    restart: unless-stopped

  # Servidores Python (3 instâncias)
  servidor1:
    build:
      context: ./python/servidor
      dockerfile: Dockerfile
    container_name: bbs_servidor1
    networks:
      - bbs_network
    ports:
      - "5001:5001"
    environment:
      - SERVIDOR_ID=servidor1
      - PORTA=5001
      - PEERS=tcp://servidor2:5002,tcp://servidor3:5003
      - REFERENCIA=tcp://referencia:5559
    volumes:
      - ./python/servidor/dados/servidor1:/app/data
    depends_on:
      - referencia
    restart: unless-stopped

  servidor2:
    build:
      context: ./python/servidor
      dockerfile: Dockerfile
    container_name: bbs_servidor2
    networks:
      - bbs_network
    ports:
      - "5002:5002"
    environment:
      - SERVIDOR_ID=servidor2
      - PORTA=5002
      - PEERS=tcp://servidor1:5001,tcp://servidor3:5003
      - REFERENCIA=tcp://referencia:5559
    volumes:
      - ./python/servidor/dados/servidor2:/app/data
    depends_on:
      - referencia
    restart: unless-stopped

  servidor3:
    build:
      context: ./python/servidor
      dockerfile: Dockerfile
    container_name: bbs_servidor3
    networks:
      - bbs_network
    ports:
      - "5003:5003"
    environment:
      - SERVIDOR_ID=servidor3
      - PORTA=5003
      - PEERS=tcp://servidor1:5001,tcp://servidor2:5002
      - REFERENCIA=tcp://referencia:5559
    volumes:
      - ./python/servidor/dados/servidor3:/app/data
    depends_on:
      - referencia
    restart: unless-stopped

  # Proxy Node.js
  proxy:
    build:
      context: ./nodejs/proxy
      dockerfile: Dockerfile
    container_name: bbs_proxy
    networks:
      - bbs_network
    ports:
      - "5556:5556"
      - "5557:5557"
    environment:
      - PROXY_FRONTEND_PORT=5556
      - PROXY_BACKEND_PORT=5557
    restart: unless-stopped

  # Broker Python
  broker:
    build:
      context: ./python/broker
      dockerfile: Dockerfile
    container_name: bbs_broker
    networks:
      - bbs_network
    ports:
      - "5555:5555"
    environment:
      - PORTA=5555
      - SERVIDORES=tcp://servidor1:5001,tcp://servidor2:5002,tcp://servidor3:5003
      - PROXY_BACKEND=tcp://proxy:5557
    depends_on:
      - servidor1
      - servidor2
      - servidor3
      - proxy
    restart: unless-stopped

  # Cliente Node.js (interativo)
  cliente:
    build:
      context: ./nodejs/cliente
      dockerfile: Dockerfile
    container_name: bbs_cliente
    networks:
      - bbs_network
    environment:
      - BROKER_ADDRESS=tcp://broker:5555
      - PROXY_ADDRESS=tcp://proxy:5556
    depends_on:
      - broker
      - proxy
    stdin_open: true
    tty: true
    profiles:
      - cliente

  # Bot de teste
  bot:
    build:
      context: ./nodejs/bot
      dockerfile: Dockerfile
    container_name: bbs_bot
    networks:
      - bbs_network
    environment:
      - BROKER_ADDRESS=tcp://broker:5555
      - PROXY_ADDRESS=tcp://proxy:5556
    depends_on:
      - broker
      - proxy
    profiles:
      - testing

networks:
  bbs_network:
    driver: bridge